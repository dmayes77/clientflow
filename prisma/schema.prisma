generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                  String    @id @default(cuid())
  clerkOrgId          String    @unique
  name                String
  email               String
  slug                String?   @unique // URL-friendly identifier for custom sign-in

  stripeCustomerId    String?   @unique
  stripeAccountId     String?   @unique
  stripeAccountStatus String?   @default("pending") // pending, active, restricted
  stripeOnboardingComplete Boolean @default(false)
  subscriptionStatus  String?   @default("trialing")
  planType            String?   @default("basic")

  // Business Information
  businessName        String?
  businessAddress     String?
  businessCity        String?
  businessState       String?
  businessZip         String?
  businessCountry     String?
  businessPhone       String?
  contactPerson       String?
  businessWebsite     String?
  businessDescription String?
  logoUrl             String?

  // Social Media Links
  facebookUrl         String?
  twitterUrl          String?
  instagramUrl        String?
  linkedinUrl         String?
  youtubeUrl          String?

  // Metadata and Setup
  metadata            Json?
  setupComplete       Boolean   @default(false)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  services            Service[]
  packages            Package[]
  clients             Client[]
  bookings            Booking[]
  apiKeys             ApiKey[]
  availability        Availability[]
  webhooks            Webhook[]
  payments            Payment[]
  images              Image[]

  @@index([clerkOrgId])
}

model Service {
  id          String    @id @default(cuid())
  tenantId    String

  name        String
  description String?
  duration    Int
  price       Int
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings    Booking[]
  packageServices PackageService[]

  @@index([tenantId])
}

model Package {
  id          String    @id @default(cuid())
  tenantId    String

  name        String
  description String?
  price       Int
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  services    PackageService[]
  bookings    Booking[]

  @@index([tenantId])
}

model PackageService {
  id        String  @id @default(cuid())
  packageId String
  serviceId String

  package   Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([packageId, serviceId])
}

model Client {
  id        String    @id @default(cuid())
  tenantId  String

  name      String
  email     String
  phone     String?
  notes     String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings  Booking[]

  @@index([tenantId])
  @@index([email])
}

model Booking {
  id              String    @id @default(cuid())
  tenantId        String
  clientId        String
  serviceId       String?
  packageId       String?

  scheduledAt     DateTime
  status          String    @default("inquiry")
  notes           String?
  totalPrice      Int
  duration        Int

  paymentStatus   String?   @default("unpaid")
  paymentId       String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client          Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service         Service?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  package         Package?  @relation(fields: [packageId], references: [id], onDelete: SetNull)
  payment         Payment?  @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientId])
  @@index([status])
  @@index([scheduledAt])
}

model ApiKey {
  id        String    @id @default(cuid())
  tenantId  String

  name      String?
  key       String    @unique
  lastUsed  DateTime?

  createdAt DateTime  @default(now())

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([key])
}

model Availability {
  id        String   @id @default(cuid())
  tenantId  String

  dayOfWeek Int
  startTime String
  endTime   String
  active    Boolean  @default(true)

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

model Webhook {
  id          String    @id @default(cuid())
  tenantId    String

  url         String
  events      String[]  // Array of event types: booking.created, client.created, etc.
  secret      String    // For signing payloads
  active      Boolean   @default(true)
  description String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveries  WebhookDelivery[]

  @@index([tenantId])
  @@index([active])
}

model WebhookDelivery {
  id          String    @id @default(cuid())
  webhookId   String

  event       String    // Event type
  payload     String    // JSON payload
  response    String?   // Response from webhook URL
  statusCode  Int?      // HTTP status code
  success     Boolean   @default(false)
  attempts    Int       @default(1)

  createdAt   DateTime  @default(now())

  webhook     Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([event])
  @@index([createdAt])
}

model Payment {
  id                    String    @id @default(cuid())
  tenantId              String
  bookingId             String?

  stripePaymentIntentId String    @unique
  stripeAccountId       String    // Connected account that receives payment

  amount                Int       // Amount in cents
  currency              String    @default("usd")
  status                String    // succeeded, pending, failed, refunded

  clientEmail           String
  clientName            String

  metadata              String?   // JSON metadata

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  tenant                Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings              Booking[]

  @@index([tenantId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([createdAt])
}

model Image {
  id          String    @id @default(cuid())
  tenantId    String

  url         String    // CDN URL of the image
  key         String    // Storage key/identifier
  name        String    // Original filename
  alt         String    // Alt text (required for accessibility)
  size        Int       // File size in bytes
  width       Int?      // Image width in pixels
  height      Int?      // Image height in pixels
  mimeType    String    // e.g., image/jpeg, image/png

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdAt])
}
