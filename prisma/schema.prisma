generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                  String    @id @default(cuid())
  clerkOrgId          String    @unique
  name                String
  email               String
  slug                String?   @unique

  stripeCustomerId    String?   @unique
  stripeAccountId     String?   @unique
  stripeSubscriptionId String?  @unique
  stripeAccountStatus String?   @default("pending")
  stripeOnboardingComplete Boolean @default(false)
  stripeTerminalLocationId String?  // Stripe Terminal Location ID for in-person payments
  subscriptionStatus  String?   @default("trialing")
  accountType         String    @default("standard") // "standard", "demo" (demo = full access, no charges, never expires)
  planId              String?   // Link to Plan model for limits/features
  planType            String?   @default("basic") // Legacy - kept for backwards compat
  currentPeriodEnd    DateTime?

  businessName        String?
  businessAddress     String?
  businessCity        String?
  businessState       String?
  businessZip         String?
  businessCountry     String?
  businessPhone       String?
  businessEmail       String?
  contactPerson       String?
  businessWebsite     String?
  businessDescription String?
  logoUrl             String?

  timezone            String    @default("America/New_York")
  slotInterval        Int       @default(30)
  breakDuration       Int       @default(60) // Daily break/lunch duration in minutes
  breakStartTime      String?   // When break starts (e.g., "12:00")
  breakEndTime        String?   // When break ends (e.g., "13:00")
  bufferTime          Int       @default(0)  // Buffer time between appointments in minutes (0-60)
  minAdvanceHours     Int       @default(24) // Minimum hours in advance required for bookings (0-168)
  defaultCalendarView String    @default("week")
  defaultTaxRate      Float     @default(0) // Default tax rate for invoices

  facebookUrl         String?
  twitterUrl          String?
  instagramUrl        String?
  linkedinUrl         String?
  youtubeUrl          String?

  metadata            Json?
  setupComplete       Boolean   @default(false)

  onboardingStep        Int       @default(0)
  onboardingCompletedAt DateTime?

  // Payment settings for customer bookings
  requirePayment        Boolean   @default(false)
  paymentType           String?   @default("full")  // "full" or "deposit"
  depositType           String?   @default("percentage")  // "fixed" or "percentage"
  depositValue          Int?      @default(50)  // cents for fixed, percentage (0-100) for percentage
  payInFullDiscount     Int?      @default(0)  // 0-15 percentage discount for paying full amount
  balanceDueAt          String?   @default("completion")  // "arrival" or "completion"

  // Push notification preferences
  pushNotificationsEnabled Boolean @default(false)
  notifyPayments           Boolean @default(true)  // Payment received, failed, disputed
  notifyBookings           Boolean @default(true)  // New bookings, cancellations
  notifySystem             Boolean @default(true)  // Trial expiring, account alerts

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  services            Service[]
  packages            Package[]
  serviceCategories   ServiceCategory[]
  contacts            Contact[]
  bookings            Booking[]
  recurringBookings   RecurringBooking[]
  bookingReminders    BookingReminder[]
  apiKeys             ApiKey[]
  availability        Availability[]
  availabilityOverrides AvailabilityOverride[]
  webhooks            Webhook[]
  payments            Payment[]
  images              Image[]
  videos              Video[]
  invoices            Invoice[]
  tags                Tag[]
  workflows           Workflow[]
  emailTemplates      EmailTemplate[]
  campaigns           Campaign[]
  terminalReaders     TerminalReader[]
  alerts              Alert[]
  pushSubscriptions   PushSubscription[]
  supportMessages     SupportMessage[]
  coupons             Coupon[]
  contactSegments     ContactSegment[]
  customFields        CustomField[]
  plan                Plan?     @relation(fields: [planId], references: [id], onDelete: SetNull)

  @@index([clerkOrgId])
  @@index([planId])
}

model ServiceCategory {
  id           String    @id @default(cuid())
  tenantId     String

  name         String
  description  String?
  color        String?   @default("#6366f1") // Indigo default
  icon         String?   // Lucide icon name or emoji
  active       Boolean   @default(true)
  displayOrder Int       @default(0)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  services     Service[]
  packages     Package[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, displayOrder])
}

model Service {
  id           String    @id @default(cuid())
  tenantId     String
  categoryId   String?

  name         String
  description  String?
  duration     Int
  price        Int
  active       Boolean   @default(true)
  includes     String[]  @default([])
  displayOrder Int       @default(0)

  archived     Boolean   @default(false)
  archivedAt   DateTime?

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category     ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  bookings     Booking[]
  bookingServices BookingService[]
  packageServices PackageService[]
  images       Image[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([archived])
  @@index([tenantId, archived])
  @@index([tenantId, categoryId, displayOrder])
}

model Package {
  id              String    @id @default(cuid())
  tenantId        String
  categoryId      String?

  name            String
  description     String?
  price           Int       // Final price after discount (in cents)
  discountPercent Int       @default(15) // 5, 10, 15, or 20
  active          Boolean   @default(true)
  displayOrder    Int       @default(0)
  includes        String[]  @default([])  // What's included in this package

  archived        Boolean   @default(false)
  archivedAt      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category        ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  services        PackageService[]
  bookings        Booking[]
  bookingPackages BookingPackage[]
  images          Image[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([archived])
  @@index([tenantId, archived])
  @@index([tenantId, categoryId, displayOrder])
}

model PackageService {
  id        String  @id @default(cuid())
  packageId String
  serviceId String

  package   Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([packageId, serviceId])
}

model Contact {
  id        String    @id @default(cuid())
  tenantId  String

  name      String
  email     String
  phone     String?
  company   String?
  website   String?
  status    String?   @default("lead") // lead, client, active, inactive, unclassified
  notes     String?

  archived   Boolean   @default(false)
  archivedAt DateTime?

  stripeCustomerId String?  @unique  // Stripe Customer ID for saved payment methods

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings           Booking[]
  invoices           Invoice[]
  payments           Payment[]
  tags               ContactTag[]
  campaignRecipients CampaignRecipient[]
  recurringBookings  RecurringBooking[]
  customFieldValues  ContactCustomFieldValue[]

  @@map("Client")
  @@index([tenantId])
  @@index([email])
  @@index([archived])
  @@index([tenantId, archived])
}

model Tag {
  id          String    @id @default(cuid())
  tenantId    String

  name        String
  color       String    @default("blue")
  description String?
  type        String    @default("general") // general, contact, invoice, booking, payment
  isSystem    Boolean   @default(false) // System tags cannot be deleted

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts    ContactTag[]
  invoices    InvoiceTag[]
  bookings    BookingTag[]
  payments    PaymentTag[]
  workflows   Workflow[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([type])
  @@index([isSystem])
}

model ContactSegment {
  id          String    @id @default(cuid())
  tenantId    String

  name        String
  description String?
  filters     Json      // Stores filter configuration (status, tags, dateRange, etc.)
  isSystem    Boolean   @default(false)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
}

model CustomField {
  id          String    @id @default(cuid())
  tenantId    String

  name        String    // Display name
  key         String    // Internal key (e.g., "pet_name")
  group       String?   // Optional group name (e.g., "Vehicle Information")
  fieldType   String    // "text", "number", "date", "select", "multiselect", "boolean", "textarea"
  options     Json?     // For select/multiselect: ["Option 1", "Option 2"]
  required    Boolean   @default(false)
  order       Int       @default(0)
  active      Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  values      ContactCustomFieldValue[]

  @@unique([tenantId, key])
  @@index([tenantId])
  @@index([active])
}

model ContactCustomFieldValue {
  id           String   @id @default(cuid())
  contactId    String
  fieldId      String
  value        String   // Stores all types as string (convert as needed)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  contact      Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  field        CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([contactId, fieldId])
  @@index([contactId])
  @@index([fieldId])
}

model ContactTag {
  id        String   @id @default(cuid())
  contactId String   @map("clientId")
  tagId     String

  createdAt DateTime @default(now())

  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@map("ClientTag")
  @@unique([contactId, tagId])
  @@index([contactId])
  @@index([tagId])
}

model InvoiceTag {
  id        String   @id @default(cuid())
  invoiceId String
  tagId     String

  createdAt DateTime @default(now())

  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, tagId])
  @@index([invoiceId])
  @@index([tagId])
}

model BookingTag {
  id        String   @id @default(cuid())
  bookingId String
  tagId     String

  createdAt DateTime @default(now())

  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([bookingId, tagId])
  @@index([bookingId])
  @@index([tagId])
}

model Workflow {
  id            String    @id @default(cuid())
  tenantId      String
  triggerTagId  String?

  name          String
  description   String?
  triggerType   String    // tag_added, tag_removed, lead_created, booking_created, booking_scheduled, booking_confirmed, booking_cancelled, client_converted, payment_received, invoice_paid, invoice_tag_added, booking_tag_added
  delayMinutes  Int       @default(0)
  actions       Json      // Array of action objects
  active        Boolean   @default(true)
  isSystem      Boolean   @default(false)  // System workflows cannot be deleted, only paused/edited
  systemKey     String?                    // Unique key for system workflows (e.g., "invoice_sent_email")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  triggerTag    Tag?      @relation(fields: [triggerTagId], references: [id], onDelete: SetNull)
  runs          WorkflowRun[]

  @@unique([tenantId, systemKey])
  @@index([tenantId])
  @@index([triggerTagId])
  @@index([active])
  @@index([systemKey])
}

model WorkflowRun {
  id          String    @id @default(cuid())
  workflowId  String
  contactId   String?   @map("clientId")

  status      String    @default("pending") // pending, running, completed, failed
  result      Json?
  error       String?

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  workflow    Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
}

model EmailTemplate {
  id          String    @id @default(cuid())
  tenantId    String

  name        String
  subject     String
  body        String    @db.Text  // HTML content from TipTap
  description String?
  category    String?   // e.g., "welcome", "follow-up", "booking", "invoice"

  // System template fields
  isSystem    Boolean   @default(false)  // Can't be deleted if true
  systemKey   String?   @unique          // e.g., "payment_reminder_gentle"

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaigns   Campaign[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([category])
  @@index([systemKey])
}

model Campaign {
  id          String    @id @default(cuid())
  tenantId    String
  templateId  String

  name        String
  description String?

  // Filters for targeting contacts
  filterTags  String[]  @default([])  // Tag IDs to include (OR logic)
  filterExcludeTags String[]  @default([])  // Tag IDs to exclude
  filterStatus String?   // Optional status filter

  // Scheduling
  status      String    @default("draft")  // "draft", "scheduled", "sending", "sent", "paused"
  scheduledFor DateTime?  // null = send immediately
  sentAt      DateTime?

  // Stats
  totalRecipients Int @default(0)
  sentCount   Int @default(0)
  deliveredCount Int @default(0)
  openedCount Int @default(0)
  clickedCount Int @default(0)
  bouncedCount Int @default(0)
  unsubscribedCount Int @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template    EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  recipients  CampaignRecipient[]

  @@index([tenantId])
  @@index([status])
  @@index([scheduledFor])
}

model CampaignRecipient {
  id          String    @id @default(cuid())
  campaignId  String
  contactId   String

  // Delivery status
  status      String    @default("pending")  // "pending", "sent", "delivered", "opened", "clicked", "bounced", "failed", "unsubscribed"

  sentAt      DateTime?
  deliveredAt DateTime?
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?
  failureReason String?

  // Tracking
  opens       Int @default(0)  // Count of opens (can be >1)
  clicks      Int @default(0)  // Count of clicks

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  campaign    Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact     Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
}

model Booking {
  id              String    @id @default(cuid())
  tenantId        String
  contactId       String    @map("clientId")
  serviceId       String?   // Legacy - kept for backwards compat
  packageId       String?   // Legacy - kept for backwards compat
  invoiceId       String?   @unique // 1:1 - each booking has at most one invoice

  scheduledAt     DateTime
  status          String    @default("pending")
  notes           String?
  totalPrice      Int
  duration        Int

  paymentStatus   String?   @default("unpaid")
  paymentId       String?

  // Payment allocation tracking (for multi-booking invoices)
  depositAllocated  Int       @default(0)  // cents - deposit allocated to this booking
  bookingAmountPaid Int       @default(0)  // cents - total paid toward this booking
  bookingBalanceDue Int?                   // cents - totalPrice - bookingAmountPaid

  // Confirmation token for secure email links (confirm/reschedule/cancel)
  confirmationToken String?   @unique

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  service         Service?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  package         Package?  @relation(fields: [packageId], references: [id], onDelete: SetNull)
  payment         Payment?  @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  invoice         Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  tags            BookingTag[]
  services        BookingService[]
  packages        BookingPackage[]
  reminders       BookingReminder[]

  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@index([scheduledAt])
}

model BookingService {
  id        String   @id @default(cuid())
  bookingId String
  serviceId String
  quantity  Int      @default(1)

  createdAt DateTime @default(now())

  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([bookingId, serviceId])
  @@index([bookingId])
  @@index([serviceId])
}

model BookingPackage {
  id        String   @id @default(cuid())
  bookingId String
  packageId String
  quantity  Int      @default(1)

  createdAt DateTime @default(now())

  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  package   Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@unique([bookingId, packageId])
  @@index([bookingId])
  @@index([packageId])
}

model RecurringBooking {
  id          String   @id @default(cuid())
  tenantId    String
  contactId   String

  // Recurrence pattern (RRULE format)
  rrule       String   // e.g., "FREQ=WEEKLY;BYDAY=MO,WE,FR;INTERVAL=1"
  startDate   DateTime // First occurrence
  endDate     DateTime? // Last occurrence (null = no end)

  // Booking template
  serviceIds  String[] @default([])
  packageIds  String[] @default([])
  duration    Int
  totalPrice  Int
  notes       String?

  // Status
  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact     Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([contactId])
  @@index([active])
  @@index([startDate])
}

model BookingReminder {
  id             String    @id @default(cuid())
  bookingId      String
  tenantId       String

  // Reminder configuration
  reminderType   String    // "email" or "sms"
  sendAt         DateTime  // When to send the reminder
  sentAt         DateTime? // When it was actually sent

  // Status
  status         String    @default("pending") // "pending", "sent", "failed"
  error          String?   // Error message if failed

  createdAt      DateTime  @default(now())

  booking        Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([tenantId])
  @@index([status])
  @@index([sendAt])
}

model ApiKey {
  id        String    @id @default(cuid())
  tenantId  String

  name      String?
  key       String    @unique
  lastUsed  DateTime?

  createdAt DateTime  @default(now())

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([key])
}

model Availability {
  id        String   @id @default(cuid())
  tenantId  String

  dayOfWeek Int
  startTime String
  endTime   String
  active    Boolean  @default(true)

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId])
}

model AvailabilityOverride {
  id        String   @id @default(cuid())
  tenantId  String

  date      DateTime @db.Date
  type      String
  startTime String?
  endTime   String?
  reason    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([date])
}

model Webhook {
  id          String    @id @default(cuid())
  tenantId    String

  url         String
  events      String[]
  secret      String
  active      Boolean   @default(true)
  description String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveries  WebhookDelivery[]

  @@index([tenantId])
  @@index([active])
}

model WebhookDelivery {
  id          String    @id @default(cuid())
  webhookId   String

  event       String
  payload     String
  response    String?
  statusCode  Int?
  success     Boolean   @default(false)
  attempts    Int       @default(1)

  createdAt   DateTime  @default(now())

  webhook     Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([event])
  @@index([createdAt])
}

model Payment {
  id                    String    @id @default(cuid())
  tenantId              String
  contactId             String    // Required: Contact is the nucleus
  bookingId             String?

  // Stripe IDs
  stripePaymentIntentId String    @unique
  stripeChargeId        String?
  stripeAccountId       String    // Connected account (tenant's)
  stripeReceiptUrl      String?

  // Amount
  amount                Int       // cents - amount actually charged
  currency              String    @default("usd")
  depositAmount         Int?      // if partial payment (null = full payment)
  serviceTotal          Int?      // Total service price (for deposit context)

  // Customer info (preserved at time of payment)
  clientEmail           String
  clientName            String

  // Card info (for chargeback evidence)
  cardBrand             String?   // visa, mastercard, amex, etc.
  cardLast4             String?

  // Status
  status                String    // succeeded, refunded, partial_refund, disputed
  refundedAmount        Int?      @default(0)
  disputeStatus         String?   // warning_needs_response, needs_response, won, lost

  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  capturedAt            DateTime?

  metadata              String?   // JSON

  tenant                Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact               Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  bookings              Booking[]
  invoices              InvoicePayment[]
  tags                  PaymentTag[]

  @@index([tenantId])
  @@index([contactId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([createdAt])
}

model Image {
  id          String    @id @default(cuid())
  tenantId    String
  serviceId   String?
  packageId   String?

  url         String
  key         String
  name        String
  alt         String
  type        String    @default("general")
  size        Int
  width       Int?
  height      Int?
  mimeType    String

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  service     Service?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  package     Package?  @relation(fields: [packageId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([serviceId])
  @@index([packageId])
  @@index([createdAt])
  @@index([type])
}

model Video {
  id          String    @id @default(cuid())
  tenantId    String

  url         String
  thumbnailUrl String?
  key         String
  name        String
  alt         String
  type        String    @default("general")
  size        Int
  width       Int?
  height      Int?
  duration    Float?
  mimeType    String

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdAt])
  @@index([type])
}

model Invoice {
  id              String    @id @default(cuid())
  tenantId        String
  contactId       String    @map("clientId")

  invoiceNumber   String
  status          String    @default("draft")

  issueDate       DateTime  @default(now())
  dueDate         DateTime
  sentAt          DateTime?
  paidAt          DateTime?
  viewedAt        DateTime?

  subtotal        Int
  discountCode    String?
  discountAmount  Int       @default(0)
  taxRate         Float     @default(0)
  taxAmount       Int       @default(0)
  total           Int
  currency        String    @default("usd")

  depositPercent  Int?      // 10, 20, 25, 50 percent options
  depositAmount   Int?      // Calculated from depositPercent
  depositPaidAt   DateTime?
  amountPaid      Int       @default(0)
  balanceDue      Int?      // Calculated: total - amountPaid

  lineItems       Json

  contactName     String    @map("clientName")
  contactEmail    String    @map("clientEmail")
  contactAddress  String?   @map("clientAddress")

  stripeCheckoutSessionId String?   @unique
  stripePaymentIntentId   String?   @unique
  stripePaymentLinkId     String?   // Stripe Payment Link ID for balance payment
  stripePaymentLinkUrl    String?   // URL for customer to pay balance

  notes           String?
  terms           String?

  // Audit trail for edits made after invoice is paid
  editHistory     Json?     // Array of { editedAt, description }

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contact         Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  booking         Booking?  // 1:1 - each invoice has at most one booking
  tags            InvoiceTag[]
  coupons         InvoiceCoupon[]
  payments        InvoicePayment[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
  @@index([contactId])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
}

model Coupon {
  id              String    @id @default(cuid())
  tenantId        String

  code            String    // Always uppercase
  description     String?

  // Discount configuration
  discountType    String    // "percentage" or "fixed"
  discountValue   Int       // 0-100 for %, cents for $

  // Applicability - empty = all items
  applicableServiceIds  String[]  @default([])
  applicablePackageIds  String[]  @default([])

  // Minimum and maximum restrictions
  minPurchaseAmount Int?     // Minimum purchase amount in cents (null = no minimum)
  maxDiscountAmount Int?     // Maximum discount amount in cents (null = no maximum)

  // Usage tracking
  maxUses         Int?      // null = unlimited
  currentUses     Int       @default(0)

  // Validity
  expiresAt       DateTime?  // null = never expires
  active          Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices        InvoiceCoupon[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([active])
  @@index([expiresAt])
}

model InvoiceCoupon {
  id              String    @id @default(cuid())
  invoiceId       String
  couponId        String

  // Snapshot at time of use
  discountType    String
  discountValue   Int
  calculatedAmount Int      // Actual discount in cents

  createdAt       DateTime  @default(now())

  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  coupon          Coupon    @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, couponId])
  @@index([invoiceId])
  @@index([couponId])
}

model InvoicePayment {
  id              String    @id @default(cuid())
  invoiceId       String
  paymentId       String

  // Amount of this payment applied to this invoice
  amountApplied   Int       // cents

  createdAt       DateTime  @default(now())

  invoice         Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payment         Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, paymentId])
  @@index([invoiceId])
  @@index([paymentId])
}

model PaymentTag {
  id        String   @id @default(cuid())
  paymentId String
  tagId     String

  createdAt DateTime @default(now())

  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([paymentId, tagId])
  @@index([paymentId])
  @@index([tagId])
}

model FeatureRequest {
  id          String    @id @default(cuid())

  email       String
  feature     String
  status      String    @default("new")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model TerminalReader {
  id              String    @id @default(cuid())
  tenantId        String

  stripeReaderId  String    @unique  // Stripe Reader ID (tmr_xxx)
  label           String              // e.g., "Front Desk", "Room 1"
  serialNumber    String?
  deviceType      String?             // e.g., "stripe_s700", "bbpos_wisepos_e"
  status          String    @default("offline")  // online, offline
  ipAddress       String?
  lastSeenAt      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
}

model Alert {
  id          String    @id @default(cuid())
  tenantId    String?   // Null for system-wide alerts

  type        String    // "dispute", "payment_failed", "account_issue", "system", "announcement"
  severity    String    @default("warning")  // "info", "warning", "error", "critical"
  title       String
  message     String
  actionUrl   String?   // Optional link to take action
  actionLabel String?   // Optional button text

  read        Boolean   @default(false)
  dismissed   Boolean   @default(false)
  isGlobal    Boolean   @default(false)  // True for system-wide alerts to all tenants

  // Reference to related entity
  referenceType String?  // "payment", "booking", "invoice"
  referenceId   String?

  metadata    Json?

  createdAt   DateTime  @default(now())
  expiresAt   DateTime? // Optional expiration for announcements
  readAt      DateTime?
  dismissedAt DateTime?

  tenant      Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dismissals  GlobalAlertDismissal[]

  @@index([tenantId])
  @@index([read])
  @@index([dismissed])
  @@index([createdAt])
  @@index([type])
  @@index([isGlobal])
}

// Track which global alerts each tenant has dismissed
model GlobalAlertDismissal {
  id        String   @id @default(cuid())
  alertId   String
  tenantId  String

  createdAt DateTime @default(now())

  alert     Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@unique([alertId, tenantId])
  @@index([tenantId])
  @@index([alertId])
}

// Automated alert rules for system-generated alerts
model AlertRule {
  id          String    @id @default(cuid())

  name        String    // e.g., "Trial Expiring Soon", "Payment Failed"
  description String?

  // Trigger configuration
  triggerType String    // "schedule" | "event" | "condition"

  // For scheduled alerts (cron-based)
  // e.g., "trial_expiring_3_days", "trial_expiring_1_day", "trial_expired"
  scheduleType String?

  // For event-based alerts (triggered by webhooks)
  // e.g., "payment_failed", "subscription_cancelled", "dispute_created"
  eventType   String?

  // Custom filters (JSON) - additional tenant targeting
  // e.g., { planIds: [], subscriptionStatuses: [], minBookings: 0, hasPaymentMethod: true }
  filters     Json?

  // Alert content
  alertType     String    @default("warning")  // info, warning, error, critical
  alertTitle    String    // Supports placeholders like {{tenantName}}
  alertMessage  String    // Supports placeholders
  actionUrl     String?   // Optional CTA link
  actionLabel   String?   // Optional CTA text

  // Behavior
  active        Boolean   @default(true)
  sendEmail     Boolean   @default(false)  // Also send email notification
  emailSubject  String?
  emailTemplate String?   // Template name or inline content

  // Prevent duplicate alerts
  cooldownHours Int       @default(24)  // Don't re-alert same tenant within X hours

  // Stats
  lastRunAt     DateTime?
  alertsSent    Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?   // Admin user ID

  @@index([triggerType])
  @@index([active])
  @@index([scheduleType])
  @@index([eventType])
}

// Track which alerts have been sent to prevent duplicates
model AlertRuleLog {
  id          String    @id @default(cuid())
  ruleId      String
  tenantId    String
  alertId     String?   // The created alert ID

  status      String    @default("sent")  // sent, failed, skipped
  error       String?

  createdAt   DateTime  @default(now())

  @@index([ruleId])
  @@index([tenantId])
  @@index([createdAt])
  @@unique([ruleId, tenantId, createdAt])
}

// Roadmap items for public roadmap display
model RoadmapItem {
  id          String    @id @default(cuid())

  title       String
  description String?
  status      String    @default("planned")  // planned, in_progress, completed, archived
  category    String?   // feature, improvement, fix, etc.
  priority    Int       @default(0)  // For ordering

  votes       Int       @default(0)
  votedBy     String[]  @default([])  // List of tenant IDs who voted

  targetDate  DateTime?
  completedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Admin user ID

  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// Changelog entries for release notes
model ChangelogEntry {
  id          String    @id @default(cuid())

  version     String?   // e.g., "1.2.0"
  title       String
  content     String    @db.Text  // Markdown content
  type        String    @default("feature")  // feature, improvement, fix, breaking
  published   Boolean   @default(false)
  publishedAt DateTime?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Admin user ID

  @@index([published])
  @@index([publishedAt])
  @@index([createdAt])
}

// Platform-wide settings (singleton pattern - only one row)
model PlatformSettings {
  id                    String    @id @default("platform")

  // Maintenance mode
  maintenanceMode       Boolean   @default(false)
  maintenanceMessage    String?
  maintenanceEndTime    DateTime?

  // Feature flags
  signupsEnabled        Boolean   @default(true)
  newTrialsEnabled      Boolean   @default(true)
  paymentsEnabled       Boolean   @default(true)
  bookingsEnabled       Boolean   @default(true)

  // Trial settings
  trialDays             Int       @default(30)
  requirePaymentMethod  Boolean   @default(false)

  // Branding / customization
  platformName          String    @default("ClientFlow")
  supportEmail          String?
  supportUrl            String?

  // Limits
  maxTenantsPerDay      Int       @default(100)
  maxBookingsPerTenant  Int       @default(1000)

  updatedAt             DateTime  @updatedAt
  updatedBy             String?   // Admin user ID who last updated
}

// Subscription plans - synced with Stripe
model Plan {
  id                String    @id @default(cuid())

  // Display info
  name              String    // e.g., "Platform", "Professional"
  slug              String    @unique  // e.g., "platform", "professional"
  description       String?
  features          String[]  @default([])  // List of feature strings

  // Pricing
  priceMonthly      Int       // Price in cents per month
  priceYearly       Int?      // Price in cents per year (optional)

  // Stripe IDs
  stripeProductId   String    @unique  // Stripe Product ID
  stripePriceId     String    @unique  // Stripe Price ID (monthly)
  stripePriceIdYearly String? @unique  // Stripe Price ID (yearly)

  // Limits for this plan
  maxContacts       Int?      // null = unlimited
  maxBookings       Int?      // null = unlimited
  maxServices       Int?      // null = unlimited

  // Status
  active            Boolean   @default(true)
  isDefault         Boolean   @default(false)  // Default plan for new signups
  sortOrder         Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  tenants           Tenant[]

  @@index([active])
  @@index([sortOrder])
}

// Push notification subscriptions for PWA
model PushSubscription {
  id          String    @id @default(cuid())
  tenantId    String
  clerkUserId String    // The specific user who subscribed

  // Web Push subscription data
  endpoint    String    @unique  // The push service endpoint URL
  p256dh      String    // Public key for encryption
  auth        String    // Authentication secret

  // Device info
  userAgent   String?
  deviceName  String?   // e.g., "iPhone 14 Pro", "Chrome on MacOS"

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastUsedAt  DateTime?

  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clerkUserId])
  @@index([endpoint])
}

model SupportMessage {
  id          String    @id @default(cuid())
  type        String    @default("support")  // "support", "bug", "feature", "error"
  subject     String
  message     String    @db.Text
  name        String?   // Name from marketing site form
  email       String?   // Email from marketing site form
  tenantId    String?   // null if from marketing site, populated if from tenant dashboard
  status      String    @default("unread")  // "unread", "read", "resolved", "archived"
  priority    String    @default("normal")  // "low", "normal", "high", "urgent"

  // Metadata: browser info, error stack, page URL, etc.
  metadata    Json?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  resolvedAt  DateTime?

  tenant      Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([type])
  @@index([tenantId])
  @@index([createdAt])
}
